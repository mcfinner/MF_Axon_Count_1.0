---
title: "MF_Axon_Count_1.0"
subtitle: "Automated Axon Counting Code"
author: "Matthew Finneran"
---
The following code was designed to automate the counting of regenerating axons in the optic nerve following crush injury.

# 0. Pre-Processing Images Before R
```{r, warning=F, message=F}
#Retinal Ganglion Cell axons were labeled with cholera-toxin-beta (CTB) and imaged at 20x with a Zeiss microscope. Images were processed with Zeiss ZEN 3.5 (blue edition) software as full-sized Tiffs. Images were imported into FIJI processing software Version 2.1.0, cropped from injury site (0 mm) to 2 mm distal to the injury site. Images were exported as jpgs and uploaded back into FIJI. Images were made to 8-bit, and saved as a Tiff. The Tiffs were saved into the working directory for the automated optic nerve axon counting code to be executed (the code contains lines to run all image files in one folder). 
```

# 1. Packages for Running the Code
```{r, warning=F, message=F}
#Load necessary packages for running the code.
library("EBImage")
library("magick")
library("ggplot2")
library("writexl")
```
 
# 2. Loading Image into R for Analysis

## 2.1. Read image into R
```{r, warning=F, message=F}
#Load pre-processed tif image into R (refer to manuscript methods for pre-processing) and then plot.
img <- readImage('Optic_Nerve_1.tif')
plot(img)

#Create a name for the image.
title <- 'Optic_Nerve_1'

#Create mask of image generated by foreground/background thresholds, identify objects, and plot.
plot(img)
kern <- makeBrush(9, shape='gaussian')
eidilat <- dilate(img, kern)
plot(eidilat)
nmask <- eidilat
plot(nmask)
```

# 3. Masking for Signal Intensity Threshold & Object Identification

## 3.1. Create Image Mask
```{r, warning=F, message=F}
#Create mask of image generated by foreground/background thresholds, identify objects, and plot.
nmask <- thresh(nmask, w=5, h= 15, offset= 0.05)
nmask <- opening(nmask, makeBrush(1, shape='line'))
nmask <- bwlabel(nmask)
plot(nmask)
```

## 3.2. Acquire identified object features
```{r, warning=F, message=F}
#Generate data tables of object features and location in the image. 
nmask_features <- data.frame(computeFeatures.shape(nmask))
nmask_moments <- data.frame(computeFeatures.moment(nmask))
nmask_feature_moment <- data.frame(nmask_features$s.area, nmask_moments$m.eccentricity)
```
 
## 3.3. Remove objects that are not "axon-like" and plot
```{r, warning=F, message=F}
#Remove objects that do not meet selection criteria for large enough "axon-like" objects and replot mask with only counted objects.
sel  <- which(nmask_feature_moment[, "nmask_features.s.area"] < 400)
  
xe <- rmObjects(nmask, sel)
plot(xe)
```

## 3.4. Plot new image with only "axon-like" objects and color-code
```{r, warning=F, message=F}
#Plot image depicting each axon-like object in a different color.
cols <- c('black', sample(rainbow(max(xe))))
zrainbow <- Image(cols[1+xe], dim=dim(xe))
plot(zrainbow)
```

# 4. Identify and Count Number of "Axon-like" Objects at Four Intervals Throughout Image

## 4.1. Determine the Dimensions of the Image 
```{r, warning=F, message=F}
#Determine dimensions of image, and then store in variables "width" & "height".
nmask <- xe
dim(nmask)
width <- dim(nmask)[1]
height <- dim(nmask)[2]
```

## 4.2. Count the Number of Axons in the First Interval
```{r, warning=F, message=F}
#Create first of four intervals to count axon-like objects (at width/4 - ((width/4)/12)).
x_2 <- width/4
x_2_2 <- x_2/12
x_2_2_2 <- x_2 - x_2_2
p1x2 <- img[1:x_2,]
zero_img <- xe[x_2_2_2:x_2,]

#Count number of axon-like objects in mask at first of four intervals, named "zero_obj."
zero_stats <- data.frame(computeFeatures.shape(zero_img))
zero_obj <- nrow(zero_stats)
plot(zero_img)

#Create colored mask to identify individual objects in the area of interest.
cols = c('black', sample(rainbow(max(zero_img))))
zero_img_color <- Image(cols[1+zero_img], dim=dim(zero_img))
pdf('Zero_Img_color.pdf')
plot(zero_img_color)
dev.off()
plot(zero_img_color)
```

## 4.3. Count the Number of Axons in the Second Interval
```{r, warning=F, message=F}
#Create second of four intervals to count axon-like objects (at width/2 - ((width/2)/12)).
y_2 <- width/2
y_2_2 <- (y_2 - x_2)/12
y_2_2_2 <- y_2 - y_2_2
p2y2 <- img[x_2:y_2,]
second_img <- xe[y_2_2_2:y_2,]

#Count number of axon-like objects in mask at second of four intervals, named "second_obj."
second_stats <- data.frame(computeFeatures.shape(second_img))
second_obj <- nrow(second_stats)
plot(second_img)

#Create colored mask to identify individual objects in the area of interest.
cols = c('black', sample(rainbow(max(second_img))))
Second_img_color <- Image(cols[1+second_img], dim=dim(second_img))
pdf('Second_Img_color.pdf')
plot(Second_img_color)
dev.off()
plot(Second_img_color)
```

## 4.4. Count the Number of Axons in the Third Interval
```{r, warning=F, message=F}
#Create third of four intervals to count axon-like objects (at (3*width/4) - ((3*width/4)/12)).
z_2 <- (3*width/4)
z_2_2 <- (z_2 - y_2)/12
z_2_2_2 <- z_2 - z_2_2
p3z2 <- img[y_2:z_2,]
third_img <- xe[z_2_2_2:z_2,]

#Count number of axon-like objects in mask at third of four intervals, named "third_obj."
third_stats <- data.frame(computeFeatures.shape(third_img))
third_obj <- nrow(third_stats)
plot(third_img)

#Create colored mask to identify individual objects in the area of interest.
cols = c('black', sample(rainbow(max(third_img))))
Third_img_color <- Image(cols[1+third_img], dim=dim(third_img))
pdf('Third_Img_color.pdf')
plot(Third_img_color)
dev.off()
plot(Third_img_color)
```

## 4.5. Count the Number of Axons in the Fourth Interval
```{r, warning=F, message=F}
#Create four of four intervals to count axon-like objects (at width - ((width)/12)).
zz_2 <- (width)
zz_2_2 <- (zz_2-z_2)/12
zz_2_2_2 <- zz_2 - zz_2_2
p4zz2 <- img[z_2:zz_2,]
fourth_img <- xe[zz_2_2_2:zz_2,]

#Count number of axon-like objects in mask at four of four intervals, named "fourth_obj."
fourth_stats <- data.frame(computeFeatures.shape(fourth_img))
fourth_obj <- nrow(fourth_stats)
plot(fourth_img)

#Create colored mask to identify individual objects in the area of interest.
cols = c('black', sample(rainbow(max(fourth_img))))
Fourth_img_color <- Image(cols[1+fourth_img], dim=dim(fourth_img))
pdf('Fourth_Img_color.pdf')
plot(Fourth_img_color)
dev.off()
plot(Fourth_img_color)
```

# 5. Convert Data to Axons Per Nerve
```{r, warning=F, message=F}
#Rename objects representing axon counts in each tissue section to interval names.
num_axon_section_0_500um <- zero_obj
num_axon_section_500_1000um <- second_obj
num_axon_section_1000_1500um <- third_obj
num_axon_section_1500_2000um <- fourth_obj

#Convert number of axons per tissue section to number of axons per nerve with the nerve thickness (14 um) and width (0.3 um).
num_axon_nerve_0_500um <- round(3.14159*(0.3/2)^2*(num_axon_section_0_500um/0.3)/0.014)
print(num_axon_nerve_0_500um)
num_axon_nerve_500_1000um <- round(3.14159*(0.3/2)^2*(num_axon_section_500_1000um/0.3)/0.014)
print(num_axon_nerve_500_1000um)
num_axon_nerve_1000_1500um <- round(3.14159*(0.3/2)^2*(num_axon_section_1000_1500um/0.3)/0.014)
print(num_axon_nerve_1000_1500um)
num_axon_nerve_1500_2000um <- round(3.14159*(0.3/2)^2*(num_axon_section_1500_2000um/0.3)/0.014)
print(num_axon_nerve_1500_2000um)
```

# 6. Consolidate & Export Data in Excel File
```{r, warning=F, message=F}
#Consolidate data for export.
Distance_from_injury_site <- c("0-500um", "500-1000um", "1000-1500um", "1500-2000um")
Number_axons_per_section <- c(num_axon_section_0_500um, num_axon_section_500_1000um, num_axon_section_1000_1500um, num_axon_section_1500_2000um)
Number_axons_per_nerve <- c(num_axon_nerve_0_500um, num_axon_nerve_500_1000um, num_axon_nerve_1000_1500um, num_axon_nerve_1500_2000um)

#Export data frame into an excel file that contains both number of axons per section & per nerve for each interval.
df <- data.frame(Distance_from_injury_site, Number_axons_per_section, Number_axons_per_nerve)
write_xlsx(df,paste0(title , "_Quantification.xlsx"))
print(df)
```

# 7. Generate Plots of Original Image, Masked Image, and Object-Identified Image
```{r, warning=F, message=F}
#Create output pdf of original image.
pdf('Image.pdf')
plot(img)
dev.off()
plot(img)

#Create output pdf of masked image.
pdf('Image-Masked.pdf')
plot(xe)
dev.off()
plot(xe)

#Create output pdf of masked image that has each object colored.
pdf('Object Identification.pdf')
plot(zrainbow)
dev.off()
plot(zrainbow)
```
