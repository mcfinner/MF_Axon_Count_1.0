---
title: "MF_Axon_Count_1.0"
subtitle: "Automated Axon Counting Code"
author: "Matthew Finneran"
---
The following code was designed to automate the counting of CTB+ regenerating axons in the optic nerve following crush injury.

# 0. Pre-Processing Images Before R
Retinal Ganglion Cell axons were labeled with cholera-toxin-beta (CTB) and imaged with a Zeiss microscope at 20X. Images were processed with Zeiss ZEN 3.5 (blue edition) software and saved as full-sized Tiffs. Images were imported into FIJI processing software Version 2.1.0, cropped from crush site - 0 mm - to 2 mm distal to the crush site, made to 8-bit, and saved as a Tiff. If needed, nerves may be straightened with FIJI plug-in for more accuracte counting. The Tiffs were saved into a single folder to create the working directory for the automated optic nerve axon counting code to be executed. 

# 1. Packages for Running the Code
Load necessary packages for running the code.
```{r, warning=F, message=F}
library("EBImage")
library("magick")
library("ggplot2")
library("writexl")
```
 
# 2. Loading Image into R for Analysis

## 2.0. Use this Code to Automate Code for All Images in Folder
Load all your Tiff files into one folder, and set as working directory. Then, put the rest of the code starting at 2.1 into the brackets of the code below in 2.0 to automate the code through all images in folder.
```{r, warning=F, message=F}
files <- list.files(full.names = TRUE)
for (file in files) {}
```

## 2.1. Read Image into R
Load pre-processed tif image into R.
```{r, warning=F, message=F}
img <- readImage(file)
```
Create a name for the image.
```{r, warning=F, message=F}  
title <- file
```
<img width="1391" alt="Screen Shot 2023-08-25 at 10 08 23 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/cb6120ca-a85d-40a8-a93a-40e63c035ff0">

# 3. Masking for Signal Intensity Threshold & Object Identification

## 3.1. Create Image Mask
Create mask of image generated by foreground/background thresholds, identify objects, and plot.
```{r, warning=F, message=F}
plot(img)
kern <- makeBrush(9, shape='gaussian')
eidilat <- dilate(img, kern)
plot(eidilat)
nmask <- eidilat
plot(nmask)
nmask <- thresh(nmask, w=5, h= 15, offset= 0.05)
nmask <- opening(nmask, makeBrush(1, shape='line'))
nmask <- bwlabel(nmask)
plot(nmask)
```
<img width="1391" alt="Screen Shot 2023-08-25 at 10 09 12 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/bb5c1074-3b7f-4ff1-bca8-84c7073d1b02">

## 3.2. Acquire Identified Object Features
Create data frame with the area and circularity of each object in image to use for thresholding axon-like objects.
```{r, warning=F, message=F}
nmask_features <- data.frame(computeFeatures.shape(nmask))
nmask_moments <- data.frame(computeFeatures.moment(nmask))
nmask_feature_moment <- data.frame(nmask_features$s.area, nmask_moments$m.eccentricity)
```
Generate data tables of object features. 

<img width="380" alt="Screen Shot 2023-08-25 at 10 10 00 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/cce14576-3216-4755-a660-564280f3ef31">
 
## 3.3. Remove Objects That Are Not "Axon-Like" and Plot
Remove objects that do not meet selection criteria for large enough axon-like objects and replot mask with only counted objects.
```{r, warning=F, message=F}
sel  <- which(nmask_feature_moment[, "nmask_features.s.area"] < 400)
xe <- rmObjects(nmask, sel)
plot(xe)
```
<img width="1392" alt="Screen Shot 2023-08-25 at 10 10 41 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/e5a50bc5-7be4-49ab-8883-4238bd2a11bd">

## 3.4. Plot New Image with only "Axon-Like" Objects and Color-Code
Plot image depicting each axon-like object in a different color.
```{r, warning=F, message=F}
cols <- c('black', sample(rainbow(max(xe))))
zrainbow <- Image(cols[1+xe], dim=dim(xe))
plot(zrainbow)
```
<img width="1392" alt="Screen Shot 2023-08-25 at 10 11 14 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/007c3b9e-1711-43ac-acbb-66c0e4ef80c7">

# 4. Identify and Count Number of "Axon-like" Objects at Four Intervals Throughout Image

## 4.1. Determine the Dimensions of the Image 
```{r, warning=F, message=F}
nmask <- xe
dim(nmask)
width <- dim(nmask)[1]
height <- dim(nmask)[2]
```

## 4.2. Count the Number of Axons in the First Interval
Create first of four intervals to count axon-like objects (at width/4 - ((width/4)/12)).
Count number of axon-like objects in mask at first of four intervals, named "zero_obj."
Create colored mask to identify individual objects in the area of interest.
```{r, warning=F, message=F}
x_2 <- width/4
x_2_2 <- x_2/6
x_2_2_2 <- x_2 - x_2_2
x_2_2_2_2 <- x_2 + x_2_2
p1x2 <- img[1:x_2,]
zero_img <- xe[x_2_2_2:x_2_2_2_2,]
zero_stats <- data.frame(computeFeatures.shape(zero_img))
zero_obj <- nrow(zero_stats)
plot(zero_img)
cols = c('black', sample(rainbow(max(zero_img))))
zero_img_color <- Image(cols[1+zero_img], dim=dim(zero_img))
plot(zero_img_color)
```

<img width="539" alt="Screen Shot 2023-08-25 at 10 13 23 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/02fd0a33-a8e5-4a57-b398-2d682be86f22">

## 4.3. Count the Number of Axons in the Second Interval
Create second of four intervals to count axon-like objects (at width/2 - ((width/2)/12)).
Count number of axon-like objects in mask at second of four intervals, named "second_obj."
Create colored mask to identify individual objects in the area of interest.
```{r, warning=F, message=F}
y_2 <- width/2
y_2_2 <- (y_2 - x_2)/6
y_2_2_2 <- y_2 - y_2_2
y_2_2_2_2 <- y_2 + y_2_2
p2y2 <- img[x_2:y_2,]
second_img <- xe[y_2_2_2:y_2_2_2_2,]
second_stats <- data.frame(computeFeatures.shape(second_img))
second_obj <- nrow(second_stats)
plot(second_img)
cols = c('black', sample(rainbow(max(second_img))))
Second_img_color <- Image(cols[1+second_img], dim=dim(second_img))
plot(Second_img_color)
```
<img width="539" alt="Screen Shot 2023-08-25 at 10 13 53 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/f41d1acf-dd43-4479-815e-7c8c12104c0b">

## 4.4. Count the Number of Axons in the Third Interval
Create third of four intervals to count axon-like objects (at (3*width/4) - ((3*width/4)/12)).
Count number of axon-like objects in mask at third of four intervals, named "third_obj."
Create colored mask to identify individual objects in the area of interest.
```{r, warning=F, message=F}
z_2 <- (3*width/4)
z_2_2 <- (z_2 - y_2)/6
z_2_2_2 <- z_2 - z_2_2
z_2_2_2_2 <- z_2 + z_2_2
p3z2 <- img[y_2:z_2,]
third_img <- xe[z_2_2_2:z_2_2_2_2,]
third_stats <- data.frame(computeFeatures.shape(third_img))
third_obj <- nrow(third_stats)
plot(third_img)
cols = c('black', sample(rainbow(max(third_img))))
Third_img_color <- Image(cols[1+third_img], dim=dim(third_img))
plot(Third_img_color)
```
<img width="539" alt="Screen Shot 2023-08-25 at 10 14 22 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/e44ab5a5-c129-410c-ae13-738d764e517f">

## 4.5. Count the Number of Axons in the Fourth Interval
Create four of four intervals to count axon-like objects (at width - ((width)/12)).
Count number of axon-like objects in mask at four of four intervals, named "fourth_obj."
Create colored mask to identify individual objects in the area of interest.
```{r, warning=F, message=F}
zz_2 <- (width)
zz_2_2 <- (zz_2-z_2)/6
zz_2_2_2 <- zz_2 - zz_2_2
p4zz2 <- img[z_2:zz_2,]
fourth_img <- xe[zz_2_2_2:zz_2,]
fourth_stats <- data.frame(computeFeatures.shape(fourth_img))
fourth_obj <- nrow(fourth_stats)
plot(fourth_img)
cols = c('black', sample(rainbow(max(fourth_img))))
Fourth_img_color <- Image(cols[1+fourth_img], dim=dim(fourth_img))
plot(Fourth_img_color)
```
<img width="270" alt="Screen Shot 2023-08-25 at 10 15 54 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/fa25698b-4987-4700-913f-edd156b95983">

# 5. Convert Data to Axons Per Nerve
Rename objects representing axon counts in each tissue section to interval names.
```{r, warning=F, message=F}
num_axon_section_0_500um <- zero_obj
num_axon_section_500_1000um <- second_obj
num_axon_section_1000_1500um <- third_obj
num_axon_section_1500_2000um <- fourth_obj
```
  
Convert number of axons per tissue section (14 um) to number of axons per nerve (assuming nerve width is ~0.3 mm).
```{r, warning=F, message=F}
num_axon_nerve_0_500um <- round(3.14159*(0.3/2)^2*(num_axon_section_0_500um/0.3)/0.014)
num_axon_nerve_500_1000um <- round(3.14159*(0.3/2)^2*(num_axon_section_500_1000um/0.3)/0.014)
num_axon_nerve_1000_1500um <- round(3.14159*(0.3/2)^2*(num_axon_section_1000_1500um/0.3)/0.014)
num_axon_nerve_1500_2000um <- round(3.14159*(0.3/2)^2*(num_axon_section_1500_2000um/0.3)/0.014)
```

# 6. Consolidate & Export Data in Excel File
Consolidate data for export.
```{r, warning=F, message=F}
Distance_from_injury_site <- c("0-500um", "500-1000um", "1000-1500um", "1500-2000um")
Number_axons_per_section <- c(num_axon_section_0_500um, num_axon_section_500_1000um, num_axon_section_1000_1500um, num_axon_section_1500_2000um)
Number_axons_per_nerve <- c(num_axon_nerve_0_500um, num_axon_nerve_500_1000um, num_axon_nerve_1000_1500um, num_axon_nerve_1500_2000um)
```

Export data frame into an excel file that contains both number of axons per section & per nerve for each interval.
```{r, warning=F, message=F}
df <- data.frame(Distance_from_injury_site, Number_axons_per_section, Number_axons_per_nerve)
write_xlsx(df,paste0(title , "_Quantification.xlsx"))
```
<img width="546" alt="Screen Shot 2023-08-25 at 10 16 41 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/ae6d6aab-49d0-409b-b5af-91815ec4941e">


# 7. Generate Plots of Original Image, Masked Image, and Object-Identified Image
Create output pdf of original image.
```{r, warning=F, message=F}
pdf('Image.pdf')
plot(img)
dev.off()
plot(img)
```
<img width="1391" alt="Screen Shot 2023-08-25 at 10 08 23 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/cb6120ca-a85d-40a8-a93a-40e63c035ff0">

Create output pdf of pre-filtered masked image.
```{r, warning=F, message=F}
pdf('Image-Prefiltered-Masked.pdf')
plot(nmask)
dev.off()
plot(nmask)
```
<img width="1391" alt="Screen Shot 2023-08-25 at 10 09 12 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/bb5c1074-3b7f-4ff1-bca8-84c7073d1b02">

Create output pdf of masked image.
```{r, warning=F, message=F}
pdf('Image-Masked.pdf')
plot(xe)
dev.off()
plot(xe)
```
<img width="1392" alt="Screen Shot 2023-08-25 at 10 10 41 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/e5a50bc5-7be4-49ab-8883-4238bd2a11bd">

Create output pdf of masked image that has each object colored.
```{r, warning=F, message=F}
pdf('Object Identification.pdf')
plot(zrainbow)
dev.off()
plot(zrainbow)
```
<img width="1392" alt="Screen Shot 2023-08-25 at 10 11 14 AM" src="https://github.com/mcfinner/MF_Axon_Count_1.0/assets/111366964/007c3b9e-1711-43ac-acbb-66c0e4ef80c7">
